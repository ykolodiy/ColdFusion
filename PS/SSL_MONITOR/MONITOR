<!---Loops through each domain in LS_DOMAINS table, comparing current date with each row’s domain expiration date --->

<cfquery datasource="myoracledatabase" name="LS_DOMAINS">
	SELECT * FROM LS_DOMAINS
</cfquery>

<cfset expiringDomains = structnew() />

<cfloop query = "LS_DOMAINS"> 
	<!---<cfoutput>#LS_DOMAINS.DATE_EXPIRES# > #now()#</cfoutput> <BR>--->
	
	<cfif #DateDiff("d", now(), LS_DOMAINS.DATE_EXPIRES)# LT 30>
		<cfset expiringDomains['#LS_DOMAINS.ROOT_DOMAIN#'] = #LS_DOMAINS.DATE_EXPIRES# >
<!---<cfelse><cfoutput>#DateDiff("d", now(), LS_DOMAINS.DATE_EXPIRES)#</cfoutput> <BR>--->
	</cfif>
	
	
</cfloop>

<cfif NOT StructIsEmpty(expiringDomains)>
	<cfdump var="#expiringDomains#"  label="Domain  expire soon">
	<cfoutput >
	The following domain names will expire within the next month:
<cfloop collection="#expiringDomains#" item="key">
  <li >
  	 #key#
  </li>  
</cfloop>
</cfoutput>
<cfelse>
	expiringDomains is EMPTY<BR>
</cfif>








<!---Loops through each cert in the LS_CERTIFICATES table, comparing the current date with each row’s certificate expiration date --->

<cfquery datasource="myoracledatabase" name="LS">
	SELECT LS_CERTIFICATES.DATE_EXPIRES LCDE, LS_SUB_DOMAINS.SUB_DOMAIN SD
	FROM LS_CERTIFICATES
	INNER JOIN LS_SUB_DOMAINS
	ON LS_CERTIFICATES.SUB_DOMAIN_ID = LS_SUB_DOMAINS.ID
	
</cfquery>

<cfset expiringCertificates = structnew() />


<cfloop query = "LS"> 
<!---	<cfoutput>#LS.LCDE# > #now()#</cfoutput> <BR>--->
	
<cfif #DateDiff("d", now(), LS.LCDE)# LT 30>
	<cfset expiringCertificates['#LS.SD#'] = #LS.LCDE# >	
<!---<cfelse><cfoutput>#DateDiff("d", now(), LS.LCDE)#</cfoutput> <BR>--->
</cfif>
	
</cfloop>

<cfif NOT StructIsEmpty(expiringCertificates)>
	<cfdump var="#expiringCertificates#" label="SSL expire soon">
<cfoutput >
	The following SSL Certificates will expire within the next month:
<cfloop collection="#expiringCertificates#" item="key">
  <li >
  	 #key#
  </li>  
</cfloop>
</cfoutput>	
	
<cfelse>
	expiringCertificates is EMPTY<BR>
</cfif>



<!---The e-mails generated by this tool --->
<!---SEND 
<cffunction name="sendMail">
<cfmail to="yuriw@ukr.net" from="noreply@pearsonlearningservices.com" subject="Learning Services - Domain Expiration Notice" > 
<h2>The following domain names will expire within the next month: </h2>
  <cfloop collection="#expiringDomains#" item="key">
     #key#: #expiringDomains[key]#<br />
</cfloop>
</cfmail>
</cffunction>

<cfset sendMail() />
--->
